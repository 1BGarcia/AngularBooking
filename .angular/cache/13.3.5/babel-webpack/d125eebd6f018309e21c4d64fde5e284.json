{"ast":null,"code":"'use strict';\n\nvar _asyncToGenerator = require(\"E:\\\\M7ProyectoAngular\\\\node_modules\\\\@babel\\\\runtime\\\\helpers\\\\asyncToGenerator.js\").default;\n\nconst SocketIO = require('socket.io');\n\nconst di = require('di');\n\nconst util = require('util');\n\nconst spawn = require('child_process').spawn;\n\nconst tmp = require('tmp');\n\nconst fs = require('fs');\n\nconst path = require('path');\n\nconst NetUtils = require('./utils/net-utils');\n\nconst root = global || window || this;\n\nconst cfg = require('./config');\n\nconst logger = require('./logger');\n\nconst constant = require('./constants');\n\nconst watcher = require('./watcher');\n\nconst plugin = require('./plugin');\n\nconst createServeFile = require('./web-server').createServeFile;\n\nconst createServeStaticFile = require('./web-server').createServeStaticFile;\n\nconst createFilesPromise = require('./web-server').createFilesPromise;\n\nconst createWebServer = require('./web-server').createWebServer;\n\nconst preprocessor = require('./preprocessor');\n\nconst Launcher = require('./launcher').Launcher;\n\nconst FileList = require('./file-list');\n\nconst reporter = require('./reporter');\n\nconst helper = require('./helper');\n\nconst events = require('./events');\n\nconst KarmaEventEmitter = events.EventEmitter;\n\nconst EventEmitter = require('events').EventEmitter;\n\nconst Executor = require('./executor');\n\nconst Browser = require('./browser');\n\nconst BrowserCollection = require('./browser_collection');\n\nconst EmitterWrapper = require('./emitter_wrapper');\n\nconst processWrapper = new EmitterWrapper(process);\n\nfunction createSocketIoServer(webServer, executor, config) {\n  const server = new SocketIO.Server(webServer, {\n    // avoid destroying http upgrades from socket.io to get proxied websockets working\n    destroyUpgrade: false,\n    path: config.urlRoot + 'socket.io/',\n    transports: config.transports,\n    forceJSONP: config.forceJSONP,\n    // Default is 5000 in socket.io v2.x and v3.x.\n    pingTimeout: config.pingTimeout || 5000,\n    // Default in v2 is 1e8 and coverage results can fail at 1e6\n    maxHttpBufferSize: 1e8\n  }); // hack to overcome circular dependency\n\n  executor.socketIoSockets = server.sockets;\n  return server;\n}\n\nclass Server extends KarmaEventEmitter {\n  constructor(cliOptionsOrConfig, done) {\n    super();\n    cliOptionsOrConfig = cliOptionsOrConfig || {};\n    this.log = logger.create('karma-server');\n    done = helper.isFunction(done) ? done : process.exit;\n    this.loadErrors = [];\n    let config;\n\n    if (cliOptionsOrConfig instanceof cfg.Config) {\n      config = cliOptionsOrConfig;\n    } else {\n      logger.setupFromConfig({\n        colors: cliOptionsOrConfig.colors,\n        logLevel: cliOptionsOrConfig.logLevel\n      });\n      const deprecatedCliOptionsMessage = 'Passing raw CLI options to `new Server(config, done)` is ' + 'deprecated. Use ' + '`parseConfig(configFilePath, cliOptions, {promiseConfig: true, throwErrors: true})` ' + 'to prepare a processed `Config` instance and pass that as the ' + '`config` argument instead.';\n      this.log.warn(deprecatedCliOptionsMessage);\n\n      try {\n        config = cfg.parseConfig(cliOptionsOrConfig.configFile, cliOptionsOrConfig, {\n          promiseConfig: false,\n          throwErrors: true\n        });\n      } catch (parseConfigError) {\n        // TODO: change how `done` falls back to exit in next major version\n        //  SEE: https://github.com/karma-runner/karma/pull/3635#discussion_r565399378\n        done(1);\n        return;\n      }\n    }\n\n    this.log.debug('Final config', util.inspect(config, false,\n    /** depth **/\n    null));\n\n    if (!config.autoWatch && !config.singleRun) {\n      this.log.warn('`autowatch` and `singleRun` are both `false`. In order to execute tests use `karma run`.');\n    }\n\n    let modules = [{\n      helper: ['value', helper],\n      logger: ['value', logger],\n      done: ['value', done || process.exit],\n      emitter: ['value', this],\n      server: ['value', this],\n      watcher: ['value', watcher],\n      launcher: ['factory', Launcher.factory],\n      config: ['value', config],\n      instantiatePlugin: ['factory', plugin.createInstantiatePlugin],\n      preprocess: ['factory', preprocessor.createPriorityPreprocessor],\n      fileList: ['factory', FileList.factory],\n      webServer: ['factory', createWebServer],\n      serveFile: ['factory', createServeFile],\n      serveStaticFile: ['factory', createServeStaticFile],\n      filesPromise: ['factory', createFilesPromise],\n      socketServer: ['factory', createSocketIoServer],\n      executor: ['factory', Executor.factory],\n      // TODO: Deprecated. Remove in the next major\n      customFileHandlers: ['value', []],\n      reporter: ['factory', reporter.createReporters],\n      capturedBrowsers: ['factory', BrowserCollection.factory],\n      args: ['value', {}],\n      timer: ['value', {\n        setTimeout() {\n          return setTimeout.apply(root, arguments);\n        },\n\n        clearTimeout\n      }]\n    }];\n    this.on('load_error', (type, name) => {\n      this.log.debug(`Registered a load error of type ${type} with name ${name}`);\n      this.loadErrors.push([type, name]);\n    });\n    modules = modules.concat(plugin.resolve(config.plugins, this));\n    this._injector = new di.Injector(modules);\n  }\n\n  start() {\n    var _this = this;\n\n    return _asyncToGenerator(function* () {\n      const config = _this.get('config');\n\n      try {\n        _this._boundServer = yield NetUtils.bindAvailablePort(config.port, config.listenAddress);\n\n        _this._boundServer.on('connection', socket => {\n          // Attach an error handler to avoid UncaughtException errors.\n          socket.on('error', err => {\n            // Errors on this socket are retried, ignore them\n            _this.log.debug('Ignoring error on webserver connection: ' + err);\n          });\n        });\n\n        config.port = _this._boundServer.address().port;\n        yield _this._injector.invoke(_this._start, _this);\n      } catch (err) {\n        _this.log.error(`Server start failed on port ${config.port}: ${err}`);\n\n        _this._close(1);\n      }\n    })();\n  }\n\n  get(token) {\n    return this._injector.get(token);\n  }\n\n  refreshFiles() {\n    return this._fileList ? this._fileList.refresh() : Promise.resolve();\n  }\n\n  refreshFile(path) {\n    return this._fileList ? this._fileList.changeFile(path) : Promise.resolve();\n  }\n\n  emitExitAsync(code) {\n    const name = 'exit';\n    let pending = this.listeners(name).length;\n    const deferred = helper.defer();\n\n    function resolve() {\n      deferred.resolve(code);\n    }\n\n    try {\n      this.emit(name, newCode => {\n        if (newCode && typeof newCode === 'number') {\n          // Only update code if it is given and not zero\n          code = newCode;\n        }\n\n        if (! --pending) {\n          resolve();\n        }\n      });\n\n      if (!pending) {\n        resolve();\n      }\n    } catch (err) {\n      deferred.reject(err);\n    }\n\n    return deferred.promise;\n  }\n\n  _start(config, launcher, preprocess, fileList, capturedBrowsers, executor, done) {\n    var _this2 = this;\n\n    return _asyncToGenerator(function* () {\n      if (config.detached) {\n        _this2._detach(config, done);\n\n        return;\n      }\n\n      _this2._fileList = fileList;\n      yield Promise.all(config.frameworks.map(framework => _this2._injector.get('framework:' + framework)));\n\n      const webServer = _this2._injector.get('webServer');\n\n      const socketServer = _this2._injector.get('socketServer');\n\n      const singleRunDoneBrowsers = Object.create(null);\n      const singleRunBrowsers = new BrowserCollection(new EventEmitter());\n      let singleRunBrowserNotCaptured = false;\n      webServer.on('error', err => {\n        _this2.log.error(`Webserver fail ${err}`);\n\n        _this2._close(1);\n      });\n\n      const afterPreprocess = () => {\n        if (config.autoWatch) {\n          const watcher = _this2.get('watcher');\n\n          _this2._injector.invoke(watcher);\n        }\n\n        webServer.listen(_this2._boundServer, () => {\n          _this2.log.info(`Karma v${constant.VERSION} server started at ${config.protocol}//${config.hostname}:${config.port}${config.urlRoot}`);\n\n          _this2.emit('listening', config.port);\n\n          if (config.browsers && config.browsers.length) {\n            _this2._injector.invoke(launcher.launch, launcher).forEach(browserLauncher => {\n              singleRunDoneBrowsers[browserLauncher.id] = false;\n            });\n          }\n\n          if (_this2.loadErrors.length > 0) {\n            _this2.log.error(new Error(`Found ${_this2.loadErrors.length} load error${_this2.loadErrors.length === 1 ? '' : 's'}`));\n\n            _this2._close(1);\n          }\n        });\n      };\n\n      fileList.refresh().then(afterPreprocess, err => {\n        _this2.log.error('Error during file loading or preprocessing\\n' + err.stack || err);\n\n        afterPreprocess();\n      });\n\n      _this2.on('browsers_change', () => socketServer.sockets.emit('info', capturedBrowsers.serialize()));\n\n      _this2.on('browser_register', browser => {\n        launcher.markCaptured(browser.id);\n\n        if (launcher.areAllCaptured()) {\n          _this2.emit('browsers_ready');\n\n          if (config.autoWatch) {\n            executor.schedule();\n          }\n        }\n      });\n\n      if (config.browserConsoleLogOptions && config.browserConsoleLogOptions.path) {\n        const configLevel = config.browserConsoleLogOptions.level || 'debug';\n        const configFormat = config.browserConsoleLogOptions.format || '%b %T: %m';\n        const configPath = config.browserConsoleLogOptions.path;\n        const configPathDir = path.dirname(configPath);\n        if (!fs.existsSync(configPathDir)) fs.mkdirSync(configPathDir, {\n          recursive: true\n        });\n\n        _this2.log.info(`Writing browser console to file: ${configPath}`);\n\n        const browserLogFile = fs.openSync(configPath, 'w+');\n        const levels = ['log', 'error', 'warn', 'info', 'debug'];\n\n        _this2.on('browser_log', function (browser, message, level) {\n          if (levels.indexOf(level.toLowerCase()) > levels.indexOf(configLevel)) {\n            return;\n          }\n\n          if (!helper.isString(message)) {\n            message = util.inspect(message, {\n              showHidden: false,\n              colors: false\n            });\n          }\n\n          const logMap = {\n            '%m': message,\n            '%t': level.toLowerCase(),\n            '%T': level.toUpperCase(),\n            '%b': browser\n          };\n          const logString = configFormat.replace(/%[mtTb]/g, m => logMap[m]);\n          this.log.debug(`Writing browser console line: ${logString}`);\n          fs.writeSync(browserLogFile, logString + '\\n');\n        });\n      }\n\n      socketServer.sockets.on('connection', socket => {\n        _this2.log.debug(`A browser has connected on socket ${socket.id}`);\n\n        const replySocketEvents = events.bufferEvents(socket, ['start', 'info', 'karma_error', 'result', 'complete']);\n        socket.on('error', err => {\n          _this2.log.debug('karma server socket error: ' + err);\n        });\n        socket.on('register', info => {\n          const knownBrowser = info.id ? capturedBrowsers.getById(info.id) || singleRunBrowsers.getById(info.id) : null;\n\n          if (knownBrowser) {\n            knownBrowser.reconnect(socket, info.isSocketReconnect);\n          } else {\n            const newBrowser = _this2._injector.createChild([{\n              id: ['value', info.id || null],\n              fullName: ['value', helper.isDefined(info.displayName) ? info.displayName : info.name],\n              socket: ['value', socket]\n            }]).invoke(Browser.factory);\n\n            newBrowser.init();\n\n            if (config.singleRun) {\n              newBrowser.execute();\n              singleRunBrowsers.add(newBrowser);\n            }\n          }\n\n          replySocketEvents();\n        });\n      });\n\n      const emitRunCompleteIfAllBrowsersDone = () => {\n        if (Object.keys(singleRunDoneBrowsers).every(key => singleRunDoneBrowsers[key])) {\n          _this2.emit('run_complete', singleRunBrowsers, singleRunBrowsers.getResults(singleRunBrowserNotCaptured, config));\n        }\n      };\n\n      _this2.on('browser_complete', completedBrowser => {\n        if (completedBrowser.lastResult.disconnected && completedBrowser.disconnectsCount <= config.browserDisconnectTolerance) {\n          _this2.log.info(`Restarting ${completedBrowser.name} (${completedBrowser.disconnectsCount} of ${config.browserDisconnectTolerance} attempts)`);\n\n          if (!launcher.restart(completedBrowser.id)) {\n            _this2.emit('browser_restart_failure', completedBrowser);\n          }\n        } else {\n          _this2.emit('browser_complete_with_no_more_retries', completedBrowser);\n        }\n      });\n\n      _this2.on('stop', done => {\n        _this2.log.debug('Received stop event, exiting.');\n\n        _this2._close();\n\n        done();\n      });\n\n      if (config.singleRun) {\n        _this2.on('browser_restart_failure', completedBrowser => {\n          singleRunDoneBrowsers[completedBrowser.id] = true;\n          emitRunCompleteIfAllBrowsersDone();\n        }); // This is the normal exit trigger.\n\n\n        _this2.on('browser_complete_with_no_more_retries', function (completedBrowser) {\n          singleRunDoneBrowsers[completedBrowser.id] = true;\n\n          if (launcher.kill(completedBrowser.id)) {\n            completedBrowser.remove();\n          }\n\n          emitRunCompleteIfAllBrowsersDone();\n        });\n\n        _this2.on('browser_process_failure', browserLauncher => {\n          singleRunDoneBrowsers[browserLauncher.id] = true;\n          singleRunBrowserNotCaptured = true;\n          emitRunCompleteIfAllBrowsersDone();\n        });\n\n        _this2.on('run_complete', (browsers, results) => {\n          _this2.log.debug('Run complete, exiting.');\n\n          _this2._close(results.exitCode);\n        });\n\n        _this2.emit('run_start', singleRunBrowsers);\n      }\n\n      if (config.autoWatch) {\n        _this2.on('file_list_modified', () => {\n          _this2.log.debug('List of files has changed, trying to execute');\n\n          if (config.restartOnFileChange) {\n            socketServer.sockets.emit('stop');\n          }\n\n          executor.schedule();\n        });\n      }\n\n      processWrapper.on('SIGINT', () => _this2._close());\n      processWrapper.on('SIGTERM', () => _this2._close());\n\n      const reportError = error => {\n        _this2.log.error(error);\n\n        process.emit('infrastructure_error', error);\n\n        _this2._close(1);\n      };\n\n      processWrapper.on('unhandledRejection', error => {\n        _this2.log.error(`UnhandledRejection: ${error.stack || error.message || String(error)}`);\n\n        reportError(error);\n      });\n      processWrapper.on('uncaughtException', error => {\n        _this2.log.error(`UncaughtException: ${error.stack || error.message || String(error)}`);\n\n        reportError(error);\n      });\n    })();\n  }\n\n  _detach(config, done) {\n    const tmpFile = tmp.fileSync({\n      keep: true\n    });\n    this.log.info('Starting karma detached');\n    this.log.info('Run \"karma stop\" to stop the server.');\n    this.log.debug(`Writing config to tmp-file ${tmpFile.name}`);\n    config.detached = false;\n\n    try {\n      fs.writeFileSync(tmpFile.name, JSON.stringify(config), 'utf8');\n    } catch (e) {\n      this.log.error(\"Couldn't write temporary configuration file\");\n      done(1);\n      return;\n    }\n\n    const child = spawn(process.argv[0], [path.resolve(__dirname, '../lib/detached.js'), tmpFile.name], {\n      detached: true,\n      stdio: 'ignore'\n    });\n    child.unref();\n  }\n  /**\n   * Cleanup all resources allocated by Karma and call the `done` callback\n   * with the result of the tests execution.\n   *\n   * @param [exitCode] - Optional exit code. If omitted will be computed by\n   * 'exit' event listeners.\n   */\n\n\n  _close(exitCode) {\n    const webServer = this._injector.get('webServer');\n\n    const socketServer = this._injector.get('socketServer');\n\n    const done = this._injector.get('done');\n\n    const webServerCloseTimeout = 3000;\n    const sockets = socketServer.sockets.sockets;\n    Object.keys(sockets).forEach(id => {\n      const socket = sockets[id];\n      socket.removeAllListeners('disconnect');\n\n      if (!socket.disconnected) {\n        process.nextTick(socket.disconnect.bind(socket));\n      }\n    });\n    this.emitExitAsync(exitCode).catch(err => {\n      this.log.error('Error while calling exit event listeners\\n' + err.stack || err);\n      return 1;\n    }).then(code => {\n      socketServer.sockets.removeAllListeners();\n      socketServer.close();\n      let removeAllListenersDone = false;\n\n      const removeAllListeners = () => {\n        if (removeAllListenersDone) {\n          return;\n        }\n\n        removeAllListenersDone = true;\n        webServer.removeAllListeners();\n        processWrapper.removeAllListeners();\n        done(code || 0);\n      };\n\n      const closeTimeout = setTimeout(removeAllListeners, webServerCloseTimeout);\n      webServer.close(() => {\n        clearTimeout(closeTimeout);\n        removeAllListeners();\n      });\n    });\n  }\n\n  stop() {\n    return this.emitAsync('stop');\n  }\n\n}\n\nServer.prototype._start.$inject = ['config', 'launcher', 'preprocess', 'fileList', 'capturedBrowsers', 'executor', 'done'];\nmodule.exports = Server;","map":{"version":3,"sources":["E:/M7ProyectoAngular/node_modules/karma/lib/server.js"],"names":["SocketIO","require","di","util","spawn","tmp","fs","path","NetUtils","root","global","window","cfg","logger","constant","watcher","plugin","createServeFile","createServeStaticFile","createFilesPromise","createWebServer","preprocessor","Launcher","FileList","reporter","helper","events","KarmaEventEmitter","EventEmitter","Executor","Browser","BrowserCollection","EmitterWrapper","processWrapper","process","createSocketIoServer","webServer","executor","config","server","Server","destroyUpgrade","urlRoot","transports","forceJSONP","pingTimeout","maxHttpBufferSize","socketIoSockets","sockets","constructor","cliOptionsOrConfig","done","log","create","isFunction","exit","loadErrors","Config","setupFromConfig","colors","logLevel","deprecatedCliOptionsMessage","warn","parseConfig","configFile","promiseConfig","throwErrors","parseConfigError","debug","inspect","autoWatch","singleRun","modules","emitter","launcher","factory","instantiatePlugin","createInstantiatePlugin","preprocess","createPriorityPreprocessor","fileList","serveFile","serveStaticFile","filesPromise","socketServer","customFileHandlers","createReporters","capturedBrowsers","args","timer","setTimeout","apply","arguments","clearTimeout","on","type","name","push","concat","resolve","plugins","_injector","Injector","start","get","_boundServer","bindAvailablePort","port","listenAddress","socket","err","address","invoke","_start","error","_close","token","refreshFiles","_fileList","refresh","Promise","refreshFile","changeFile","emitExitAsync","code","pending","listeners","length","deferred","defer","emit","newCode","reject","promise","detached","_detach","all","frameworks","map","framework","singleRunDoneBrowsers","Object","singleRunBrowsers","singleRunBrowserNotCaptured","afterPreprocess","listen","info","VERSION","protocol","hostname","browsers","launch","forEach","browserLauncher","id","Error","then","stack","serialize","browser","markCaptured","areAllCaptured","schedule","browserConsoleLogOptions","configLevel","level","configFormat","format","configPath","configPathDir","dirname","existsSync","mkdirSync","recursive","browserLogFile","openSync","levels","message","indexOf","toLowerCase","isString","showHidden","logMap","toUpperCase","logString","replace","m","writeSync","replySocketEvents","bufferEvents","knownBrowser","getById","reconnect","isSocketReconnect","newBrowser","createChild","fullName","isDefined","displayName","init","execute","add","emitRunCompleteIfAllBrowsersDone","keys","every","key","getResults","completedBrowser","lastResult","disconnected","disconnectsCount","browserDisconnectTolerance","restart","kill","remove","results","exitCode","restartOnFileChange","reportError","String","tmpFile","fileSync","keep","writeFileSync","JSON","stringify","e","child","argv","__dirname","stdio","unref","webServerCloseTimeout","removeAllListeners","nextTick","disconnect","bind","catch","close","removeAllListenersDone","closeTimeout","stop","emitAsync","prototype","$inject","module","exports"],"mappings":"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","sourcesContent":["'use strict'\n\nconst SocketIO = require('socket.io')\nconst di = require('di')\nconst util = require('util')\nconst spawn = require('child_process').spawn\nconst tmp = require('tmp')\nconst fs = require('fs')\nconst path = require('path')\n\nconst NetUtils = require('./utils/net-utils')\nconst root = global || window || this\n\nconst cfg = require('./config')\nconst logger = require('./logger')\nconst constant = require('./constants')\nconst watcher = require('./watcher')\nconst plugin = require('./plugin')\n\nconst createServeFile = require('./web-server').createServeFile\nconst createServeStaticFile = require('./web-server').createServeStaticFile\nconst createFilesPromise = require('./web-server').createFilesPromise\nconst createWebServer = require('./web-server').createWebServer\nconst preprocessor = require('./preprocessor')\nconst Launcher = require('./launcher').Launcher\nconst FileList = require('./file-list')\nconst reporter = require('./reporter')\nconst helper = require('./helper')\nconst events = require('./events')\nconst KarmaEventEmitter = events.EventEmitter\nconst EventEmitter = require('events').EventEmitter\nconst Executor = require('./executor')\nconst Browser = require('./browser')\nconst BrowserCollection = require('./browser_collection')\nconst EmitterWrapper = require('./emitter_wrapper')\nconst processWrapper = new EmitterWrapper(process)\n\nfunction createSocketIoServer (webServer, executor, config) {\n  const server = new SocketIO.Server(webServer, {\n    // avoid destroying http upgrades from socket.io to get proxied websockets working\n    destroyUpgrade: false,\n    path: config.urlRoot + 'socket.io/',\n    transports: config.transports,\n    forceJSONP: config.forceJSONP,\n    // Default is 5000 in socket.io v2.x and v3.x.\n    pingTimeout: config.pingTimeout || 5000,\n    // Default in v2 is 1e8 and coverage results can fail at 1e6\n    maxHttpBufferSize: 1e8\n  })\n\n  // hack to overcome circular dependency\n  executor.socketIoSockets = server.sockets\n\n  return server\n}\n\nclass Server extends KarmaEventEmitter {\n  constructor (cliOptionsOrConfig, done) {\n    super()\n    cliOptionsOrConfig = cliOptionsOrConfig || {}\n    this.log = logger.create('karma-server')\n    done = helper.isFunction(done) ? done : process.exit\n    this.loadErrors = []\n\n    let config\n    if (cliOptionsOrConfig instanceof cfg.Config) {\n      config = cliOptionsOrConfig\n    } else {\n      logger.setupFromConfig({\n        colors: cliOptionsOrConfig.colors,\n        logLevel: cliOptionsOrConfig.logLevel\n      })\n      const deprecatedCliOptionsMessage =\n        'Passing raw CLI options to `new Server(config, done)` is ' +\n        'deprecated. Use ' +\n        '`parseConfig(configFilePath, cliOptions, {promiseConfig: true, throwErrors: true})` ' +\n        'to prepare a processed `Config` instance and pass that as the ' +\n        '`config` argument instead.'\n      this.log.warn(deprecatedCliOptionsMessage)\n      try {\n        config = cfg.parseConfig(\n          cliOptionsOrConfig.configFile,\n          cliOptionsOrConfig,\n          {\n            promiseConfig: false,\n            throwErrors: true\n          }\n        )\n      } catch (parseConfigError) {\n        // TODO: change how `done` falls back to exit in next major version\n        //  SEE: https://github.com/karma-runner/karma/pull/3635#discussion_r565399378\n        done(1)\n        return\n      }\n    }\n\n    this.log.debug('Final config', util.inspect(config, false, /** depth **/ null))\n\n    if (!config.autoWatch && !config.singleRun) {\n      this.log.warn('`autowatch` and `singleRun` are both `false`. In order to execute tests use `karma run`.')\n    }\n\n    let modules = [{\n      helper: ['value', helper],\n      logger: ['value', logger],\n      done: ['value', done || process.exit],\n      emitter: ['value', this],\n      server: ['value', this],\n      watcher: ['value', watcher],\n      launcher: ['factory', Launcher.factory],\n      config: ['value', config],\n      instantiatePlugin: ['factory', plugin.createInstantiatePlugin],\n      preprocess: ['factory', preprocessor.createPriorityPreprocessor],\n      fileList: ['factory', FileList.factory],\n      webServer: ['factory', createWebServer],\n      serveFile: ['factory', createServeFile],\n      serveStaticFile: ['factory', createServeStaticFile],\n      filesPromise: ['factory', createFilesPromise],\n      socketServer: ['factory', createSocketIoServer],\n      executor: ['factory', Executor.factory],\n      // TODO: Deprecated. Remove in the next major\n      customFileHandlers: ['value', []],\n      reporter: ['factory', reporter.createReporters],\n      capturedBrowsers: ['factory', BrowserCollection.factory],\n      args: ['value', {}],\n      timer: ['value', {\n        setTimeout () {\n          return setTimeout.apply(root, arguments)\n        },\n        clearTimeout\n      }]\n    }]\n\n    this.on('load_error', (type, name) => {\n      this.log.debug(`Registered a load error of type ${type} with name ${name}`)\n      this.loadErrors.push([type, name])\n    })\n\n    modules = modules.concat(plugin.resolve(config.plugins, this))\n    this._injector = new di.Injector(modules)\n  }\n\n  async start () {\n    const config = this.get('config')\n    try {\n      this._boundServer = await NetUtils.bindAvailablePort(config.port, config.listenAddress)\n      this._boundServer.on('connection', (socket) => {\n        // Attach an error handler to avoid UncaughtException errors.\n        socket.on('error', (err) => {\n          // Errors on this socket are retried, ignore them\n          this.log.debug('Ignoring error on webserver connection: ' + err)\n        })\n      })\n      config.port = this._boundServer.address().port\n      await this._injector.invoke(this._start, this)\n    } catch (err) {\n      this.log.error(`Server start failed on port ${config.port}: ${err}`)\n      this._close(1)\n    }\n  }\n\n  get (token) {\n    return this._injector.get(token)\n  }\n\n  refreshFiles () {\n    return this._fileList ? this._fileList.refresh() : Promise.resolve()\n  }\n\n  refreshFile (path) {\n    return this._fileList ? this._fileList.changeFile(path) : Promise.resolve()\n  }\n\n  emitExitAsync (code) {\n    const name = 'exit'\n    let pending = this.listeners(name).length\n    const deferred = helper.defer()\n\n    function resolve () {\n      deferred.resolve(code)\n    }\n\n    try {\n      this.emit(name, (newCode) => {\n        if (newCode && typeof newCode === 'number') {\n          // Only update code if it is given and not zero\n          code = newCode\n        }\n        if (!--pending) {\n          resolve()\n        }\n      })\n\n      if (!pending) {\n        resolve()\n      }\n    } catch (err) {\n      deferred.reject(err)\n    }\n    return deferred.promise\n  }\n\n  async _start (config, launcher, preprocess, fileList, capturedBrowsers, executor, done) {\n    if (config.detached) {\n      this._detach(config, done)\n      return\n    }\n\n    this._fileList = fileList\n\n    await Promise.all(\n      config.frameworks.map((framework) => this._injector.get('framework:' + framework))\n    )\n\n    const webServer = this._injector.get('webServer')\n    const socketServer = this._injector.get('socketServer')\n\n    const singleRunDoneBrowsers = Object.create(null)\n    const singleRunBrowsers = new BrowserCollection(new EventEmitter())\n    let singleRunBrowserNotCaptured = false\n\n    webServer.on('error', (err) => {\n      this.log.error(`Webserver fail ${err}`)\n      this._close(1)\n    })\n\n    const afterPreprocess = () => {\n      if (config.autoWatch) {\n        const watcher = this.get('watcher')\n        this._injector.invoke(watcher)\n      }\n\n      webServer.listen(this._boundServer, () => {\n        this.log.info(`Karma v${constant.VERSION} server started at ${config.protocol}//${config.hostname}:${config.port}${config.urlRoot}`)\n\n        this.emit('listening', config.port)\n        if (config.browsers && config.browsers.length) {\n          this._injector.invoke(launcher.launch, launcher).forEach((browserLauncher) => {\n            singleRunDoneBrowsers[browserLauncher.id] = false\n          })\n        }\n        if (this.loadErrors.length > 0) {\n          this.log.error(new Error(`Found ${this.loadErrors.length} load error${this.loadErrors.length === 1 ? '' : 's'}`))\n          this._close(1)\n        }\n      })\n    }\n\n    fileList.refresh().then(afterPreprocess, (err) => {\n      this.log.error('Error during file loading or preprocessing\\n' + err.stack || err)\n      afterPreprocess()\n    })\n\n    this.on('browsers_change', () => socketServer.sockets.emit('info', capturedBrowsers.serialize()))\n\n    this.on('browser_register', (browser) => {\n      launcher.markCaptured(browser.id)\n\n      if (launcher.areAllCaptured()) {\n        this.emit('browsers_ready')\n\n        if (config.autoWatch) {\n          executor.schedule()\n        }\n      }\n    })\n\n    if (config.browserConsoleLogOptions && config.browserConsoleLogOptions.path) {\n      const configLevel = config.browserConsoleLogOptions.level || 'debug'\n      const configFormat = config.browserConsoleLogOptions.format || '%b %T: %m'\n      const configPath = config.browserConsoleLogOptions.path\n      const configPathDir = path.dirname(configPath)\n      if (!fs.existsSync(configPathDir)) fs.mkdirSync(configPathDir, { recursive: true })\n      this.log.info(`Writing browser console to file: ${configPath}`)\n      const browserLogFile = fs.openSync(configPath, 'w+')\n      const levels = ['log', 'error', 'warn', 'info', 'debug']\n      this.on('browser_log', function (browser, message, level) {\n        if (levels.indexOf(level.toLowerCase()) > levels.indexOf(configLevel)) {\n          return\n        }\n        if (!helper.isString(message)) {\n          message = util.inspect(message, { showHidden: false, colors: false })\n        }\n        const logMap = { '%m': message, '%t': level.toLowerCase(), '%T': level.toUpperCase(), '%b': browser }\n        const logString = configFormat.replace(/%[mtTb]/g, (m) => logMap[m])\n        this.log.debug(`Writing browser console line: ${logString}`)\n        fs.writeSync(browserLogFile, logString + '\\n')\n      })\n    }\n\n    socketServer.sockets.on('connection', (socket) => {\n      this.log.debug(`A browser has connected on socket ${socket.id}`)\n\n      const replySocketEvents = events.bufferEvents(socket, ['start', 'info', 'karma_error', 'result', 'complete'])\n\n      socket.on('error', (err) => {\n        this.log.debug('karma server socket error: ' + err)\n      })\n\n      socket.on('register', (info) => {\n        const knownBrowser = info.id ? (capturedBrowsers.getById(info.id) || singleRunBrowsers.getById(info.id)) : null\n\n        if (knownBrowser) {\n          knownBrowser.reconnect(socket, info.isSocketReconnect)\n        } else {\n          const newBrowser = this._injector.createChild([{\n            id: ['value', info.id || null],\n            fullName: ['value', (helper.isDefined(info.displayName) ? info.displayName : info.name)],\n            socket: ['value', socket]\n          }]).invoke(Browser.factory)\n\n          newBrowser.init()\n\n          if (config.singleRun) {\n            newBrowser.execute()\n            singleRunBrowsers.add(newBrowser)\n          }\n        }\n\n        replySocketEvents()\n      })\n    })\n\n    const emitRunCompleteIfAllBrowsersDone = () => {\n      if (Object.keys(singleRunDoneBrowsers).every((key) => singleRunDoneBrowsers[key])) {\n        this.emit('run_complete', singleRunBrowsers, singleRunBrowsers.getResults(singleRunBrowserNotCaptured, config))\n      }\n    }\n\n    this.on('browser_complete', (completedBrowser) => {\n      if (completedBrowser.lastResult.disconnected && completedBrowser.disconnectsCount <= config.browserDisconnectTolerance) {\n        this.log.info(`Restarting ${completedBrowser.name} (${completedBrowser.disconnectsCount} of ${config.browserDisconnectTolerance} attempts)`)\n\n        if (!launcher.restart(completedBrowser.id)) {\n          this.emit('browser_restart_failure', completedBrowser)\n        }\n      } else {\n        this.emit('browser_complete_with_no_more_retries', completedBrowser)\n      }\n    })\n\n    this.on('stop', (done) => {\n      this.log.debug('Received stop event, exiting.')\n      this._close()\n      done()\n    })\n\n    if (config.singleRun) {\n      this.on('browser_restart_failure', (completedBrowser) => {\n        singleRunDoneBrowsers[completedBrowser.id] = true\n        emitRunCompleteIfAllBrowsersDone()\n      })\n\n      // This is the normal exit trigger.\n      this.on('browser_complete_with_no_more_retries', function (completedBrowser) {\n        singleRunDoneBrowsers[completedBrowser.id] = true\n\n        if (launcher.kill(completedBrowser.id)) {\n          completedBrowser.remove()\n        }\n\n        emitRunCompleteIfAllBrowsersDone()\n      })\n\n      this.on('browser_process_failure', (browserLauncher) => {\n        singleRunDoneBrowsers[browserLauncher.id] = true\n        singleRunBrowserNotCaptured = true\n\n        emitRunCompleteIfAllBrowsersDone()\n      })\n\n      this.on('run_complete', (browsers, results) => {\n        this.log.debug('Run complete, exiting.')\n        this._close(results.exitCode)\n      })\n\n      this.emit('run_start', singleRunBrowsers)\n    }\n\n    if (config.autoWatch) {\n      this.on('file_list_modified', () => {\n        this.log.debug('List of files has changed, trying to execute')\n        if (config.restartOnFileChange) {\n          socketServer.sockets.emit('stop')\n        }\n        executor.schedule()\n      })\n    }\n\n    processWrapper.on('SIGINT', () => this._close())\n    processWrapper.on('SIGTERM', () => this._close())\n\n    const reportError = (error) => {\n      this.log.error(error)\n      process.emit('infrastructure_error', error)\n      this._close(1)\n    }\n\n    processWrapper.on('unhandledRejection', (error) => {\n      this.log.error(`UnhandledRejection: ${error.stack || error.message || String(error)}`)\n      reportError(error)\n    })\n\n    processWrapper.on('uncaughtException', (error) => {\n      this.log.error(`UncaughtException: ${error.stack || error.message || String(error)}`)\n      reportError(error)\n    })\n  }\n\n  _detach (config, done) {\n    const tmpFile = tmp.fileSync({ keep: true })\n    this.log.info('Starting karma detached')\n    this.log.info('Run \"karma stop\" to stop the server.')\n    this.log.debug(`Writing config to tmp-file ${tmpFile.name}`)\n    config.detached = false\n    try {\n      fs.writeFileSync(tmpFile.name, JSON.stringify(config), 'utf8')\n    } catch (e) {\n      this.log.error(\"Couldn't write temporary configuration file\")\n      done(1)\n      return\n    }\n    const child = spawn(process.argv[0], [path.resolve(__dirname, '../lib/detached.js'), tmpFile.name], {\n      detached: true,\n      stdio: 'ignore'\n    })\n    child.unref()\n  }\n\n  /**\n   * Cleanup all resources allocated by Karma and call the `done` callback\n   * with the result of the tests execution.\n   *\n   * @param [exitCode] - Optional exit code. If omitted will be computed by\n   * 'exit' event listeners.\n   */\n  _close (exitCode) {\n    const webServer = this._injector.get('webServer')\n    const socketServer = this._injector.get('socketServer')\n    const done = this._injector.get('done')\n\n    const webServerCloseTimeout = 3000\n    const sockets = socketServer.sockets.sockets\n\n    Object.keys(sockets).forEach((id) => {\n      const socket = sockets[id]\n      socket.removeAllListeners('disconnect')\n      if (!socket.disconnected) {\n        process.nextTick(socket.disconnect.bind(socket))\n      }\n    })\n\n    this.emitExitAsync(exitCode).catch((err) => {\n      this.log.error('Error while calling exit event listeners\\n' + err.stack || err)\n      return 1\n    }).then((code) => {\n      socketServer.sockets.removeAllListeners()\n      socketServer.close()\n\n      let removeAllListenersDone = false\n      const removeAllListeners = () => {\n        if (removeAllListenersDone) {\n          return\n        }\n        removeAllListenersDone = true\n        webServer.removeAllListeners()\n        processWrapper.removeAllListeners()\n        done(code || 0)\n      }\n\n      const closeTimeout = setTimeout(removeAllListeners, webServerCloseTimeout)\n\n      webServer.close(() => {\n        clearTimeout(closeTimeout)\n        removeAllListeners()\n      })\n    })\n  }\n\n  stop () {\n    return this.emitAsync('stop')\n  }\n}\n\nServer.prototype._start.$inject = ['config', 'launcher', 'preprocess', 'fileList', 'capturedBrowsers', 'executor', 'done']\n\nmodule.exports = Server\n"]},"metadata":{},"sourceType":"script"}